<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>SmartRide - Booking & Driver Info</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      margin: 0;
      background: linear-gradient(to right, #667eea, #764ba2);
      color: white;
      padding: 20px;
      position: relative;
    }

    h1 { margin-bottom: 30px; font-size: 28px; font-weight: 700; text-align: center; }
    h2 { font-weight: 600; font-size: 16px; margin-bottom: 10px; }
    h3 { margin-bottom: 10px; }

    .card {
      background: white; color: #333; padding: 30px 25px;
      border-radius: 20px; box-shadow: 0px 8px 25px rgba(0,0,0,0.1);
      width: 90%; max-width: 400px; text-align: center;
      animation: fadeIn 0.6s ease;
      margin-bottom: 20px;
    }

    input { width: 90%; max-width: 300px; padding: 14px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 15px; font-size: 14px; outline: none; transition: 0.3s; }
    input:focus { border-color: #764ba2; box-shadow: 0 0 0 3px rgba(118, 75, 162, 0.15); }

    .btn { width: 90%; max-width: 300px; padding: 14px; border: none; border-radius: 10px; background: linear-gradient(to right, #667eea, #764ba2); color: white; font-weight: 600; font-size: 14px; cursor: pointer; transition: transform 0.2s ease; margin-top: 10px; }
    .btn:hover { transform: scale(1.03); }

    .btn-outline { background: transparent; border: 2px solid #764ba2; color: #764ba2; font-weight: 600; margin-top: 5px; margin-bottom: 15px; }

    .rides { margin-top: 30px; display: grid; gap: 20px; justify-items: center; width: 100%; max-width: 800px; }

    .ride-card { background: white; color: #333; padding: 20px; border-radius: 15px; box-shadow: 0px 6px 15px rgba(0,0,0,0.1); width: 90%; max-width: 320px; text-align: center; }

    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    #reportContainer { position: fixed; bottom: 20px; right: 20px; z-index: 1000; display: flex; flex-direction: column; align-items: flex-end; }
    #reportOptions { flex-direction: column; gap: 10px; margin-top: 10px; overflow: hidden; max-height: 0; opacity: 0; transition: max-height 0.3s ease, opacity 0.3s ease; display: none; }

    .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; z-index:1000; }
    .modal-content { width:90%; height:80%; background:white; border-radius:15px; overflow:hidden; position:relative; }
    .modal-close { position:absolute; top:10px; right:15px; background:#764ba2; color:white; border:none; border-radius:50%; width:35px; height:35px; font-size:18px; cursor:pointer; }
    iframe { width:100%; height:100%; border:none; }
  </style>
</head>
<body>
  <h1>üöñ SmartRide: Hassle-Free Campus Transport</h1>

  <!-- Ride Booking -->
  <div class="card">
    <input id="pickup" placeholder="Pickup Point" />
    <input id="drop" placeholder="Destination" />
    <button id="chooseMapBtn" class="btn btn-outline">üìç Choose on Map</button>
    <button class="btn" id="bookRideBtn">Book Ride</button>
  </div>

  <!-- Active Rides -->
  <div id="rides" class="rides"></div>

  <!-- Map Modal -->
  <div id="mapModal" class="modal">
    <div class="modal-content">
      <button id="closeMapBtn" class="modal-close">‚úï</button>
      <iframe id="mapFrame" src="map.html"></iframe>
    </div>
  </div>

  <!-- Report -->
  <div id="reportContainer">
    <button id="reportBtn" class="btn">üö® Report</button>
    <div id="reportOptions">
      <button class="btn">Bouncers</button>
      <button class="btn">Police</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import {
      getFirestore, collection, addDoc, serverTimestamp, getDocs,
      updateDoc, doc, deleteDoc, getDoc, query, where, onSnapshot
    } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAHoQR6Y1TZlJROgY63tY_x-qBwEqYFSgU",
      authDomain: "project-ab4c9.firebaseapp.com",
      projectId: "project-ab4c9",
      storageBucket: "project-ab4c9.firebasestorage.app",
      messagingSenderId: "256359032769",
      appId: "1:256359032769:web:6e5f8ca8ac38e301c93140"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUserUid = "";
    onAuthStateChanged(auth, (user) => {
      currentUserUid = user ? user.uid : "";
      if(currentUserUid) listenActiveRide(); // start real-time listener
    });

    let activeInput = null;
    let pickupCoords = null, dropCoords = null;
    let pickupName = "", dropName = "";

    const pickupInput = document.getElementById('pickup');
    const dropInput = document.getElementById('drop');
    const ridesDiv = document.getElementById('rides');

    pickupInput.addEventListener('focus', () => activeInput = 'pickup');
    dropInput.addEventListener('focus', () => activeInput = 'drop');

    // Map modal logic
    const chooseMapBtn = document.getElementById('chooseMapBtn');
    const mapModal = document.getElementById('mapModal');
    const closeMapBtn = document.getElementById('closeMapBtn');

    chooseMapBtn.addEventListener('click', () => {
      if(!activeInput) return alert("Focus on Pickup or Drop first!");
      mapModal.style.display = 'flex';
      document.getElementById("mapFrame").contentWindow.postMessage({
        type: "focusedInput",
        inputName: activeInput
      }, "*");
    });

    closeMapBtn.addEventListener('click', () => {
      mapModal.style.display = 'none';
    });

    window.addEventListener("message", function(event){
      if(event.data.type === "locationSelected"){
        const loc = event.data.location;
        const coords = event.data.coords;

        if(activeInput === 'pickup'){
          pickupInput.value = loc;
          pickupCoords = coords;
          pickupName = loc;
        } else {
          dropInput.value = loc;
          dropCoords = coords;
          dropName = loc;
        }
        mapModal.style.display = 'none';
      }
    });

    // Hotspot & distance utils
    function getDistance(lat1, lon1, lat2, lon2){
      const R = 6371;
      const dLat = (lat2-lat1)*Math.PI/180;
      const dLon = (lon2-lon1)*Math.PI/180;
      const a = Math.sin(dLat/2)*2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*2;
      const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    async function findNearbyHotspot(lat, lng){
      const snaps = await getDocs(collection(db, "Hotspots"));
      for(const hs of snaps.docs){
        const data = hs.data();
        if(!data?.location) continue;
        const d = getDistance(lat, lng, data.location.lat, data.location.lng);
        if(d <= 0.2) return { id: hs.id, data };
      }
      return null;
    }

    async function incrementHotspot(lat, lng, name){
      const matched = await findNearbyHotspot(lat, lng);
      if(matched){
        const hsRef = doc(db, "Hotspots", matched.id);
        const newCount = (matched.data.count || 0) + 1;
        await updateDoc(hsRef, { count: newCount });
        return matched.id;
      } else {
        const newRef = await addDoc(collection(db, "Hotspots"), {
          location: { lat, lng },
          name: name || "",
          count: 1,
          createdAt: serverTimestamp()
        });
        return newRef.id;
      }
    }

    async function decrementHotspot(hotspotId){
      const hsRef = doc(db, "Hotspots", hotspotId);
      const hsSnap = await getDoc(hsRef);
      if(!hsSnap.exists()) return;
      const newCount = (hsSnap.data().count || 1) - 1;
      if(newCount <= 0){
        await deleteDoc(hsRef);
      } else {
        await updateDoc(hsRef, { count: newCount });
      }
    }

    // Ride booking
    document.getElementById('bookRideBtn').addEventListener('click', async () => {
      const uid = currentUserUid || (auth.currentUser ? auth.currentUser.uid : "");
      if(!uid){ alert("Please sign in first."); return; }
      if(!pickupCoords || !dropCoords){ alert("Select pickup & drop."); return; }

      const q = query(collection(db, "Rides"), where("studentId","==",uid), where("Status","==","requested"));
      const qSnap = await getDocs(q);
      if(!qSnap.empty){ alert("You already have an active ride."); return; }

      const distance = getDistance(pickupCoords.lat, pickupCoords.lng, dropCoords.lat, dropCoords.lng);
      const fare = Math.round(distance * 13);

      const hotspotId = await incrementHotspot(pickupCoords.lat, pickupCoords.lng, pickupName || pickupInput.value);

      const rideDocRef = await addDoc(collection(db, "Rides"), {
        Pickup: { lat: pickupCoords.lat, lng: pickupCoords.lng, name: pickupName || pickupInput.value },
        Destination: { lat: dropCoords.lat, lng: dropCoords.lng, name: dropName || dropInput.value },
        Distance: distance,
        Fare: fare,
        DriverId: "",
        Status: "requested",
        requestedAt: serverTimestamp(),
        studentId: uid,
        Hotspotid: hotspotId
      });

      pickupInput.value=""; dropInput.value="";
      pickupCoords=null; dropCoords=null; pickupName=""; dropName="";
    });

    // Report button toggle
    const reportBtn = document.getElementById('reportBtn');
    const reportOptions = document.getElementById('reportOptions');
    let isOpen = false;
    reportBtn.addEventListener('click', () => {
      isOpen = !isOpen;
      if (isOpen) {
        reportOptions.style.display = "flex";
        requestAnimationFrame(() => {
          reportOptions.style.maxHeight = reportOptions.scrollHeight + "px";
          reportOptions.style.opacity = "1";
        });
      } else {
        reportOptions.style.maxHeight = "0";
        reportOptions.style.opacity = "0";
        reportOptions.addEventListener('transitionend', function handler() {
          if (!isOpen) {
            reportOptions.style.display = "none";
          }
          reportOptions.removeEventListener('transitionend', handler);
        });
      }
    });

    // ======= REAL-TIME LISTENER FOR ACTIVE RIDE & DRIVER INFO =======
    async function listenActiveRide(){
      const ridesCol = collection(db, "Rides");
      const q = query(ridesCol, where("studentId","==",currentUserUid), where("Status","in", ["requested", "accepted"]));
      onSnapshot(q, async snapshot => {
        ridesDiv.innerHTML = "";
        if(snapshot.empty){
          ridesDiv.innerHTML = "<p>No active rides.</p>";
          return;
        }

        for(const rideDoc of snapshot.docs){
          const rideData = rideDoc.data();
          let driverInfoHTML = "";
          if(rideData.DriverId){
            const driverSnap = await getDoc(doc(db,"drivers",rideData.DriverId));
            if(driverSnap.exists()){
              const driver = driverSnap.data();
              driverInfoHTML = `
                <p>üöó <strong>Driver:</strong> ${driver.name}</p>
                <p><strong>Phone:</strong> ${driver.phone}</p>
                <p><strong>Vehicle:</strong> ${driver.vehicle}</p>
                <p><strong>License:</strong> ${driver.license}</p>
              `;
            }
          }

          const rideCard = document.createElement("div");
          rideCard.className = "ride-card";
          rideCard.innerHTML = `
            <h2>${rideData.Pickup.name} ‚ûù ${rideData.Destination.name}</h2>
            <p>Distance: ${rideData.Distance.toFixed(2)} km</p>
            <p>Fare: ‚Çπ${rideData.Fare}</p>
            ${driverInfoHTML}
            <button class="btn btn-outline" id="cancelBtn">Cancel Ride</button>
          `;
          ridesDiv.appendChild(rideCard);

          rideCard.querySelector("#cancelBtn").addEventListener("click", async ()=> {
            const confirmDelete = confirm("Cancel ride?");
            if(confirmDelete){
              if(rideData.Hotspotid) await decrementHotspot(rideData.Hotspotid);
              await deleteDoc(doc(db,"Rides",rideDoc.id));
            }
          });
        }
      });
    }
  </script>
</body>
</html>