<!DOCTYPE html>
<html>
<head>
  <title>Choose Pickup/Destination</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    #map { width: 100%; height: 100%; }
    body, html { margin:0; padding:0; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>

  <script>
    const map = L.map('map').setView([0, 0], 15);

    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/">CARTO</a>',
      subdomains: 'abcd',
      maxZoom: 20
    }).addTo(map);

    // Markers
    let currentMarker = L.circleMarker([0,0], { radius:8, color:'blue', fillColor:'blue', fillOpacity:0.9 }).addTo(map);
    let accuracyCircle, pickupMarker=null, destinationMarker=null;

    function success(pos) {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const accuracy = pos.coords.accuracy;

      currentMarker.setLatLng([lat,lng])
        .bindPopup(`Current Location (Â±${Math.round(accuracy)} m)`).openPopup();

      if(accuracyCircle) {
        accuracyCircle.setLatLng([lat,lng]).setRadius(accuracy);
      } else {
        accuracyCircle = L.circle([lat,lng], { radius:accuracy, color:'#136aec', fillColor:'#136aec', fillOpacity:0.2 }).addTo(map);
      }

      map.setView([lat,lng],17);
    }

    function error(err){ alert("Could not get location: "+err.message); }

    if(navigator.geolocation){
      navigator.geolocation.watchPosition(success,error,{ enableHighAccuracy:true, timeout:10000, maximumAge:0 });
    }

    async function reverseGeocode(lat,lng){
      const url = `https://nominatim.openstreetmap.org/reverse?format=jsonv2&lat=${lat}&lon=${lng}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        return data.display_name || `${lat}, ${lng}`;
      } catch { return `${lat}, ${lng}`; }
    }

    // Track which input is focused in parent
    let focusedInput = null;

    window.addEventListener("message", function(event){
      if(event.data.type==="focusedInput"){
        focusedInput = event.data.inputName; // 'pickup' or 'drop'
      }
    });

    map.on("click", async function(e){
      const lat = e.latlng.lat.toFixed(6);
      const lng = e.latlng.lng.toFixed(6);

      const placeName = await reverseGeocode(lat,lng);

      if(focusedInput === 'pickup'){
        if(pickupMarker) map.removeLayer(pickupMarker);
        pickupMarker = L.marker([lat,lng], {icon:L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',iconSize:[25,41],iconAnchor:[12,41]})})
                        .addTo(map)
                        .bindPopup(`Pickup: ${placeName}`).openPopup();
      } else {
        if(destinationMarker) map.removeLayer(destinationMarker);
        destinationMarker = L.marker([lat,lng], {icon:L.icon({iconUrl:'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',iconSize:[25,41],iconAnchor:[12,41]})})
                          .addTo(map)
                          .bindPopup(`Destination: ${placeName}`).openPopup();
      }

      // Send location back to parent including coordinates
      parent.postMessage({
        type:"locationSelected",
        location: placeName,
        coords: { lat: parseFloat(lat), lng: parseFloat(lng) }
      }, "*");
    });
  </script>
</body>
</html>
